version: '3'

#env:
  
tasks:
  up:
    desc: Creates Azure infrastructure and deploys application code
    cmds:
    - terraform -chdir=./infrastructure workspace new {{.REGION}} || true
    - terraform -chdir=./infrastructure workspace select {{.REGION}}
    - terraform -chdir=./infrastructure init
    - task: apply
    vars:
      REGION: '{{default "southcentralus" .CLI_ARGS}}'

  apply: 
    cmds:
    - terraform -chdir=./infrastructure apply -auto-approve -var "region={{.REGION}}"
    vars:
      REGION: '{{default "southcentralus" .CLI_ARGS}}'

  build:
    desc: Builds application code with Docker
    cmds:
    - az acr login -n {{.ACR_NAME}}
    - az acr build -t sql-job:{{.COMMIT_HASH}} -r {{.ACR_NAME}} src/.
    vars:
      ACR_NAME: 
        sh: terraform -chdir=./infrastructure output -raw ACR_NAME
      COMMIT_HASH:
        sh: git rev-parse HEAD | head -c 8

  deploy: 
    cmds:
    - terraform -chdir=./app workspace new {{.APP_NAME}} || true
    - terraform -chdir=./app workspace select {{.APP_NAME}}
    - terraform -chdir=./app init
    - terraform -chdir=./app apply -auto-approve -var "app_name={{.APP_NAME}}"  -var "commit={{.COMMIT_HASH}}"
    vars:
      APP_NAME: 
        sh: terraform -chdir=./infrastructure output -raw APP_NAME
      COMMIT_HASH:
        sh: git rev-parse HEAD | head -c 8

  down:
    desc: Destroys all Azure resources and cleans up Terraform
    cmds:
    - az group list --tag Application="Azure Container Apps Job Demo with Azure SQL" --query "[].name" -o tsv | xargs -ot -n 1 az group delete -y --no-wait -n
    - cd ./app; rm -rf terraform.tfstate.d .terraform.lock.hcl .terraform terraform.tfstate terraform.tfstate.backup .terraform.tfstate.lock.info
    - cd ./infrastructure; rm -rf terraform.tfstate.d .terraform.lock.hcl .terraform terraform.tfstate terraform.tfstate.backup .terraform.tfstate.lock.info

